<script>
  /* 
  -------------------------------------------------------------  
  EXAMPLE walker.js TRACKING IMPLEMENTATION FOR SERVER-SIDE GTM  
  -------------------------------------------------------------  
  */
  
  //send as image in case of CORS issues
  window._walkerSettings = {};
  window._walkerSettings.sendAsImage = true;
  window._walkerSettings.sendBase64 = false;
  window._walkerSettings.version = 1
  // enter your endpoint url here like https://ssgtm.example.com/elbwalker 
  window._walkerSettings.endpointUrl = "https://httpbin.org/anything";
  // add a path like https://ssgtm.example.com/walker.js or a locally stored
  // copy instead of using the CDN 
  window._walkerSettings.walkerpath = "https://cdn.jsdelivr.net/npm/@elbwalker/walker.js@1.5.3/dist/walker.js";
  window._walkerSettings.doAnalytics = true;
  
  /*************** END SETUP *****************/
  
  //simple session and client handling - switch to cookies or move server-side if you like
  function getSessionData() {
    if (window._walkerSettings.doAnalytics !== true) return;
    var sts = window.sessionStorage.getItem("lg_sts");
    var sid = window.sessionStorage.getItem("lg_sid");
    var sct = window.localStorage.getItem("lg_sct") || 0;
    var cid = window.localStorage.getItem("lg_cid");
  
    var sStart = false;
  
    if (!sts) {
      //new session
      sStart = true;
      sts = Math.round(Date.now() / 1000);
      sid = Math.round(Math.random() * 10000000000);
      window.sessionStorage.setItem("lg_sts", sts);
      window.sessionStorage.setItem("lg_sid", sid);
      sct++;
      window.localStorage.setItem("lg_sct", sct);
    }
  
    //simple user management via localStorage as well - switch to cookies or set
    //server-side id cookie for a more robust identification of returning visitors 
    if (!cid) {
      //just paste random session id and timestamp for a new persistent client id
      cid = sts+"."+sid;
      window.localStorage.setItem("lg_cid", cid);
    }
  
    return {
      sessionId: sid, 
      sessionNumber: sct, 
      sessionStartTimestamp: sts, 
      clientId: cid, 
      sessionStart: sStart
    };
  }
  
  //function to push data to queue
  function elb() {
    (window.elbLayer = window.elbLayer || []).push(arguments);
  }
  
  (function(w,a,l,k,e,r){
    w = window; 
    a = w._walkerSettings;
    l = document.location.href;
    k = document.title;
    r = a.endpointUrl;
  
    //load walker.js?
    var wp = a.walkerpath;
    if (wp) {
      var wsc = document.createElement("script");
      wsc.type = "text/javascript"; 
      wsc.className = "elbwalker"
      wsc.dataset.version = a.version||"1"
      wsc.async = true; 
      wsc.defer = true; 
      wsc.src = wp; 
      document.head.appendChild(wsc);
    }
  
    //minimal bot detection, "stolen" from Trackboxx (https://cdn.trackboxx.info/p/tracker.js)
    if (/bot|google|baidu|bing|msn|duckduckbot|teoma|slurp|yandex/i.test(navigator.userAgent)) return false;
    
    if ((a.sendBase64 !== true) && (a.sendAsImage === true)) {
      l = l.split("#")[0];
    } 
    
    //add some "globals" to config to add common event parameters
    var globals = {page_title: k};
  
    //send consent with every event: can be used in ssGTM to trigger specific tags. 
    //Adjust to match your needs and send a list of allowed services or set of markers
    //like this one: 
    elb("walker consent", {analytics_consent: a.doAnalytics});
  
    //call session handling and set user attributes + elements for session id and number 
    var sD = getSessionData();
    if (sD) {
      elb("walker user", {hash: sD.sessionId, device: sD.clientId});
  
      //add global session parameters for GA4 processing in ssGTM
      globals.session_started = sD.sessionStartTimestamp;
      globals.session_number = sD.sessionNumber;
      //session start marker for GA4
      if (sD.sessionStart === true) 
        globals.session_start = true;
    }  
  
    elb("walker config", { globals: globals }); 
  
    //send hit as image request to avoid CORS problems, beacon and AJAX are (better) options in any other case
    elb("walker destination", { push: 
      function (event) {
        if (event.data && event.data.hash && 
        (w._walkerSettings.sendBase64 !== true) && 
        (w._walkerSettings.sendAsImage === true)) {
        event.data.hash = event.data.hash.replace("#", "");
        } 
        var obs = JSON.stringify(event);
        //base64 coding for serialized object    
        if (obs === "{}") 
        obs = ""; 
        else if (w._walkerSettings.sendBase64 === true) 
        obs = btoa(unescape(encodeURIComponent(obs)));
        var params = (obs !== "") ? "?o=" + encodeURI(obs) : "";
        if (w.XMLHttpRequest) e = new XMLHttpRequest();
        if ((e !== null) && (w._walkerSettings.sendAsImage !== true)) {
          e.open("POST", r, true);
          //you might have to change this to "application/json" depending
          //on your endpoint
          e.setRequestHeader("Content-Type", "text/plain");
          e.send(obs);
          //alternative method: use fetch() - okay for almost every browser
          /*
          fetch(r, {method: "POST", cache: "no-cache", 
            headers: {
              "X-Gtm-Server-Preview":"xxxx", 
              "Content-Type": "application/json"
            }, body: obs}
          );
          */
        } else  
          (new Image()).src = r + params;
        //log event to console for debugging purposes 
        console.log(event);
      }
    }); 
    //start the magic!
    elb("walker run");
  })();
  
</script>